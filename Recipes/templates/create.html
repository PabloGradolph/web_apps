{% extends "base.html" %}

{% block title %}
Create Recipe
{% endblock %}

{% block content %}
<h1>Create a New Recipe</h1>
<form method="POST">
    {{ form.hidden_tag() }}

    <!-- Título -->
    <div>
        {{ form.title.label }} {{ form.title(size=32) }}
        {% if form.title.errors %}
            <ul class="errors">
                {% for error in form.title.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    <!-- Descripción -->
    <div>
        {{ form.description.label }} {{ form.description(rows=4) }}
        {% if form.description.errors %}
            <ul class="errors">
                {% for error in form.description.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    <!-- Servings y Cook Time -->
    <div>
        {{ form.servings.label }} {{ form.servings }}
        {% if form.servings.errors %}
            <ul class="errors">
                {% for error in form.servings.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>
    <div>
        {{ form.cook_time.label }} {{ form.cook_time }}
        {% if form.cook_time.errors %}
            <ul class="errors">
                {% for error in form.cook_time.errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    <h3>Ingredients</h3>
    <div id="ingredients">
        <div class="ingredient-template ingredient" style="display: none;">
            {{ form.ingredients[0].name.label }} {{ form.ingredients[0].name }}
            {{ form.ingredients[0].quantity.label }} {{ form.ingredients[0].quantity }}
            <button type="button" class="remove-ingredient">Remove</button>
        </div>
    </div>
    <button type="button" id="add-ingredient">Add Ingredient</button>
    
    <h3>Steps</h3>
    <div id="steps">
        <div class="step-template step" style="display: none;">
            {{ form.steps.description.label }} {{ form.steps.description }}
            <button type="button" class="remove-step">Remove</button>
        </div>
    </div>
    <button type="button" id="add-step">Add Step</button>

    <div>
        {{ form.submit() }}
    </div>
</form>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Funciones para agregar y eliminar campos de ingredientes
    function addIngredient() {
        var container = document.getElementById('ingredients');
        var newIngredient = document.querySelector('.ingredient-template').cloneNode(true);
        var ingredientCount = container.querySelectorAll('.ingredient').length;
    
        // Actualiza los atributos name y id para cada campo en el nuevo ingrediente
        newIngredient.querySelectorAll('input, select, textarea').forEach(function(input) {
            input.name = input.name.replace('[0]', '[' + ingredientCount + ']');
            input.id = input.id.replace('_0', '_' + ingredientCount);
        });
    
        newIngredient.style.display = 'block';
        container.appendChild(newIngredient);
    }

    function removeIngredient(button) {
        if (document.querySelectorAll('ingredient').length > 1) {
            button.parentNode.remove();
        } else {
            alert('You must have at least one ingredient.');
        }
    }

    // Funciones para agregar y eliminar pasos
    function addStep() {
        var container = document.getElementById('steps');
        var newStep = document.querySelector('.step-template').cloneNode(true); // Clona todos los nodos hijos
        var stepCount = container.querySelectorAll('.step').length;
    
        // Actualiza los atributos name y id para cada campo en el nuevo paso
        newStep.querySelectorAll('input, select, textarea').forEach(function(input) {
            input.name = input.name.replace('[0]', '[' + stepCount + ']');
            input.id = input.id.replace('_0', '_' + stepCount);
        });
    
        newStep.style.display = 'block';
        container.appendChild(newStep);
    }

    function removeStep(button) {
        if (document.querySelectorAll('.step').length > 1) {
            button.parentNode.remove();
        } else {
            alert('You must have at least one step.');
        }
    }

    document.querySelector('#add-ingredient').addEventListener('click', addIngredient);
    document.querySelector('#add-step').addEventListener('click', addStep);

    document.querySelector('#ingredients').addEventListener('click', function (e) {
        if (e.target && e.target.className == 'remove-ingredient') {
            removeIngredient(e.target);
        }
    });

    document.querySelector('#steps').addEventListener('click', function (e) {
        if (e.target && e.target.className == 'remove-step') {
            removeStep(e.target);
        }
    });
});
</script>
{% endblock %}